# CLI Lights Out — Specification

## 概要

Go で実装されたターミナル常駐型 Lights Out パズル。

- ANSI escape と raw terminal input によりリアルタイム操作
- 通常のゲームモード
- 「数理解析モード」：GF(4) 重み（行・列の重み和）を表示し、解析的に扱える拡張盤面を提供

本仕様では、**ゲームモードから数理解析モードに入る際の“外周の埋め方”を重要機能として定義**する。

---

## 技術制約

- Go 1.22
- 単一バイナリ
- 実行環境: Linux terminal
- raw mode 入力（例: `golang.org/x/term`）
- ANSI escape による描画
- 外部 UI ライブラリ不使用（標準＋最小依存）

---

## 盤面・ルールの定義

### 通常（ゲームモード）盤面

- サイズ: `m × n`（m,n は 2–20 程度）
- セル状態: on/off（bool）

### 反転ルール（基本）

- 通常モードの基本反転は「押したセル + 周囲8近傍（3×3）」を反転
  - ただし将来、解析モード内で「1マス反転」も切替可能にする（後述）

---

## モード一覧

### 1) ゲームモード

#### 目的
通常の Lights Out を遊ぶ。

#### 操作（例）
- hjkl / ←↓↑→ : カーソル移動
- Space / Enter : 反転（通常：3×3）
- U : undo
- R : 解ける配置でリスタート
- Q : メニューへ戻る
- **隠しコマンド** : 数理解析モードへ移行（後述）

#### クリア条件
- 全セル消灯でクリア

#### 初期盤面生成
- 「必ず解ける配置」を生成する scramble を用意する（scrambleSolvable）。

---

### 2) 数理解析モード

#### 目的
GF(4) による行・列重み表示を用いて盤面の性質を観察・調整できる拡張モード。
ゲームモードからの移行時には、**外周を“可解化”のために適切に埋める**。

#### 盤面サイズ（重要）
- **解析モードは、ゲームモード盤面 `m×n` を外周1マスで囲う**
- よって解析モード盤面サイズは **`(m+2) × (n+2)`**
  - 内部（元のゲーム盤面）: 行 `1..m`, 列 `1..n`
  - 外周: 上段 `row=0`, 下段 `row=m+1`, 左端 `col=0`, 右端 `col=n+1`

#### 表示
- 外周セルは背景色で区別（例: 青/シアン）
- **GF(4) 重み和を、盤面の右端と下端に表示**
  - 右端: 各行の重み和
  - 下端: 各列の重み和
  -（UI上は “盤面の右側・下側に添える”形。実装上は別領域描画でよい）

#### 操作
- hjkl / ←↓↑→ : 移動
- Space / Enter : 反転（デフォルトは通常反転＝3×3）
- U : undo
- Q : メニューへ戻る
- **T : 反転モード切替**
  - 通常反転（3×3） ↔ **1マス反転（単点反転）**
  - 目的：初期配置をユーザが1マスずつ選択する編集ができるようにするため

#### 解析モード内の盤面生成（任意機能）
- E : 全消灯盤面を生成
- S : 内部セルのみの操作で可解配置生成
- A : 任意配置生成（可解保証なし）
（この辺は実装状況により残す/消す）

---

## GF(4) の定義と重み

GF(4) = GF(2)[x]/(x² + x + 1)

要素:
- 0, 1, ω, ω²（ω²=ω+1 など）

各セル (r,c) に対して GF(4) 重み `w(r,c)` を割り当てる。
（例: `w(r,c)=ω^(r+c)` のような規則。規則自体は実装に合わせて固定する）

行和:
- RowSum[r] = Σ_c  board[r][c] * w(r,c)

列和:
- ColSum[c] = Σ_r  board[r][c] * w(r,c)

ここで `board[r][c]` は on=1/off=0（GF(2) 埋め込み）として扱う。

---

## ★ 重要仕様：ゲームモード → 数理解析モード遷移（外周の可解化）

### 隠しコマンド
- ゲームモード中で1秒間に５回連続でYを連打したら数理解析モードへ以下の流れで遷移する。

ゲームモード中の隠しコマンドで解析モードへ移行する際、次の処理を行う。

### 入力
- ゲームモード盤面 `B`（サイズ m×n）

### 出力
- 解析モード盤面 `E`（サイズ (m+2)×(n+2)）
- 内部 `E[1..m][1..n]` は `B` をそのまま埋め込む
- 外周 `E` の値を **適切に選び**、GF(4) の行列重み表示が「全て 0」になるようにする

### 目的（ユーザ価値）
- **この遷移で得られる解析モード盤面は“可解”になる**（ユーザが解ける）
- ユーザは「元の盤面に外周を足して解析モードに持ち込む」ことで、解析による解法/理解に移行できる

### 制約（外周埋め）
- 外周（row=0, row=m+1, col=0, col=n+1）のセルを 0/1 で設定する
- 設定の仕方の“ミソ”は次：
  - **右端と下端に表示される GF(4) 行和/列和が、すべて 0 になるように外周を埋める**
  - つまり `RowSum[r]=0`（解析モードで表示する全行）、`ColSum[c]=0`（全列）を満たすようにする

### 具体的な構成方針（実装指針）
- 内部を固定したうえで、外周セルを未知変数として扱う
- 行和/列和を計算し、未確定の外周セルに 0/1 を割り当てて **全行・全列の合計重みが 0** になるようにする
- 実装は「完全に厳密な線形方程式ソルバ」でもよいが、まずは次の簡易方針を採用する：

#### 簡易方針（要求に沿ったもの）
- 外周のうち “空いている部分” を埋めて、行・列の重みが 0 になるようにする
- **外周の埋めはランダム性を入れてよい**
  - ただし最終的に制約を満たすように調整する（ランダム → 修正 の順でもよい）

※注：この仕様は「どう実装するか」を縛るのではなく、**遷移後の E が“重み表示ゼロ条件”を満たすこと**を要請する。

---

## メニュー/画面遷移

- メニュー画面（トップ）:
  1. 行数 m
  2. 列数 n
  3. モード選択（ゲーム / 解析）
- **ゲームモード選択画面からメニュー画面へ戻れる**ようにする
  -（現在「戻る」が弱い/不明瞭なら、UI上で明示する）

---

## 既存機能（実装済み想定）

- raw terminal
- リアルタイム描画
- undo（スナップショット方式など）
- solvable scramble
- GF(4) 表示（行/列重み）
- vim-style navigation

---

## 追加要件・今後の拡張（ロードマップ）

### HTML/JS 版
- 将来的に同等機能を HTML+JS で実装し、GitHub Pages 等でデプロイ可能にする
- コアロジック（盤面操作・反転・GF(4)計算）を分離し移植しやすくするのが望ましい

### 解析モードの編集機能
- 解析モードで「通常反転」⇄「1マス反転」を切替できる（Tキーなど）
- 目的：初期配置をユーザがセル単位で設定できる

### ゲーム→解析の遷移の強化
- 遷移時の外周埋めは「切り替える瞬間の内部配置」に対して必ず可解化されるようにする
- 埋め方はランダム性を含んで良いが、最終的に全行・全列の GF(4) 重みが 0 になること

